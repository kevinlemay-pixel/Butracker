<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <title>My STM Tracker</title>
    <style>
        :root { --bg: #000; --card: #1c1c1e; --text: #fff; --accent: #0a84ff; --go: #30d158; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, sans-serif; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; justify-content: center; margin: 0; }
        .header { font-size: 1rem; color: #8e8e93; text-transform: uppercase; letter-spacing: 1px; }
        .stop-name { font-size: 1.5rem; font-weight: 800; margin: 10px 0 25px 0; text-align: center; }
        .main-timer { background: var(--card); width: 100%; max-width: 350px; padding: 40px 20px; border-radius: 25px; text-align: center; border: 1px solid #333; box-shadow: 0 10px 30px rgba(0,0,0,0.5); box-sizing: border-box; }
        .minutes { font-size: 6rem; font-weight: 900; color: var(--go); line-height: 1; margin-bottom: 5px; }
        .bus-badge { background: var(--accent); padding: 6px 15px; border-radius: 10px; font-size: 1.4rem; font-weight: bold; display: inline-block; margin-top: 15px; }
        .btn { margin-top: 30px; background: #2c2c2e; color: var(--accent); border: none; padding: 15px; border-radius: 15px; width: 100%; max-width: 350px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .status { margin-top: 15px; font-size: 0.8rem; color: #555; }
    </style>
</head>
<body>

    <div class="header">HEADING TO</div>
    <div class="stop-name" id="stop-label">---</div>

    <div class="main-timer">
        <div class="minutes" id="time">--</div>
        <div id="unit-label" style="font-size: 1rem; color: #888; font-weight: bold;">MINS AWAY</div>
        <div class="bus-badge" id="bus-num">Line --</div>
    </div>

    <button class="btn" onclick="updateData()">REFRESH LIVE DATA</button>
    <div class="status" id="last-update">Updating...</div>

    <script>
        const API_KEY = "l7f3b0cc56068c4d43aba9832d89ac833f";
        
        function getTargetStop() {
            const hour = new Date().getHours();
            return (hour < 12) ? 
                { id: '53344', dest: 'HonorÃ©-Beaugrand', lines: ['186', '187'] } : 
                { id: '53724', dest: 'Sherbrooke / Fletcher', lines: ['186', '187', '487'] };
        }

        async function updateData() {
            const stop = getTargetStop();
            document.getElementById('stop-label').innerText = stop.dest;
            document.getElementById('last-update').innerText = "Updating...";

            // AllOrigins Proxy wraps the data in a "contents" field
            const stmUrl = `https://api.stm.info/pub/od/gtfs-rt/ic/v2/stopArrivals/${stop.id}`;
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(stmUrl)}`;

            try {
                const response = await fetch(proxyUrl, {
                    headers: { 'apiKey': API_KEY }
                });
                
                const json = await response.json();
                // THIS IS THE FIX: We must parse the "contents" string
                const data = JSON.parse(json.contents); 
                
                const arrivals = data.arrivals.filter(a => stop.lines.includes(a.route_id));
                
                if (arrivals && arrivals.length > 0) {
                    document.getElementById('time').innerText = arrivals[0].minutesAway;
                    document.getElementById('bus-num').innerText = "Line " + arrivals[0].route_id;
                    document.getElementById('unit-label').innerText = "MINS AWAY";
                } else {
                    document.getElementById('time').innerText = "OFF";
                    document.getElementById('bus-num').innerText = "No Bus Scheduled";
                    document.getElementById('unit-label').innerText = "CHECK CHRONO";
                }
                
                document.getElementById('last-update').innerText = "Last updated: " + new Date().toLocaleTimeString();
            } catch (err) {
                console.error("Fetch Error:", err);
                document.getElementById('time').innerText = "!";
                document.getElementById('bus-num').innerText = "Check API/Internet";
            }
        }

        updateData();
        setInterval(updateData, 30000); 
    </script>
</body>
</html>
